<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CRF Map with Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div id="map"></div>
  <div id="sidebar">
    <input id="searchInput" placeholder="Search by name, country, email..." />
    <!--<div class="filter-buttons" id="filterButtons"></div>-->
    <div id="legend">
      <div><span style="display:inline-block;width:10px;height:10px;background:#d19c32;border-radius:50%;margin-right:5px;"></span>Full Membership</div>
      <div><span style="display:inline-block;width:10px;height:10px;background:#173751;border-radius:50%;margin-right:5px;"></span>Observer Membership</div>
      <div><span style="display:inline-block;width:10px;height:10px;background:#404040;border-radius:50%;margin-right:5px;"></span>Associate Membership</div>
    </div>
    <div id="businessList"></div>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Load your data (memberProfiles, businesses) -->
  <script src="data.js"></script>
  
  <!-- Main logic -->
  <script>
      const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [31, 12],
      zoom: 0.2,
      projection: 'mercator' //  Flat map
    });

    map.on('load', () => {
      // Hide country labels
      const countryLabelLayers = [
        'country-label',
        'country-label-sm',
        'country-label-md',
        'country-label-lg'
      ];
    
      countryLabelLayers.forEach(layerId => {
        if (map.getLayer(layerId)) {
          map.setLayoutProperty(layerId, 'visibility', 'none');
        }
      });
    
      // Hide country borders
      const borderLayers = [
        'admin-0-boundary',
        'admin-0-boundary-bg',
        'admin-0-boundary-disputed',
        'admin-1-boundary'
      ];
    
      borderLayers.forEach(layerId => {
        if (map.getLayer(layerId)) {
          map.setLayoutProperty(layerId, 'visibility', 'none');
        }
      });
    });
    
    const sidebar = document.getElementById('businessList');
    const searchInput = document.getElementById('searchInput');
    const filterButtons = document.getElementById('filterButtons');

    const uniqueCountries = [...new Set(businesses.map(b => b.country))];
    let selectedCountry = 'All';
    let searchTerm = '';

    const markers = [];

    // Add filter buttons
    function renderFilterButtons() {
      const countries = ['All', ...uniqueCountries];
      filterButtons.innerHTML = '';
      countries.forEach(country => {
        const btn = document.createElement('button');
        btn.textContent = country;
        btn.className = selectedCountry === country ? 'active' : '';
        btn.onclick = () => {
          selectedCountry = country;
          renderBusinesses();
        };
        filterButtons.appendChild(btn);
      });
    }

    // Render business list and markers
    function renderBusinesses() {
      sidebar.innerHTML = '';
      markers.forEach(m => m.remove());
      markers.length = 0;

      const filtered = businesses.filter(b => {
        const matchCountry = selectedCountry === 'All' || b.country === selectedCountry;
        const matchText = Object.values(b).some(val =>
          typeof val === 'string' && val.toLowerCase().includes(searchTerm.toLowerCase())
        );
        return matchCountry && matchText;
      });

      filtered.forEach(biz => {
        // Choose color based on membershipType
        let color = "#812383"; // default
        if (biz.membershipType === "Full") color = "#d19c32";
        else if (biz.membershipType === "Observer") color = "#173751";
        else if (biz.membershipType === "Associate") color = "#404040";
        
        const div = document.createElement('div');
        div.className = 'business';
        div.innerHTML = `
          <h3>${biz.name}</h3>
          <p><strong>${biz.country}</strong></p>
          <p>${biz.address}</p>
          <p><a href="mailto:${biz.email}">${biz.email}</a></p>
          <p>Phone: ${biz.phone}</p>
          <p><a href="${biz.website}" target="_blank">Website</a></p>
          ${biz.memberUrl ? `<p><a href="${biz.memberUrl}" target="_blank">View Profile</a></p>` : ''}
        `;

        // Get the map container height
        const mapHeight = map.getContainer().clientHeight;
        
        div.onclick = () => {
          map.flyTo({
            center: biz.coords,
            zoom: 5,
            essential: true,
            padding: {
              top: 0,
              bottom: mapHeight * 0.5,  // Push the point up by ~50% of map height
              left: 0,
              right: 0
            }
          });
        };
        sidebar.appendChild(div);
        
        const el = document.createElement('div');
        el.style.width = '10px';
        el.style.height = '10px';
        el.style.backgroundColor = color;
        el.style.borderRadius = '50%';
        el.style.border = '2px solid white';
        el.style.boxShadow = '0 0 0px rgba(0,0,0,0.0)';
        el.style.cursor = 'pointer';
        
        const marker = new mapboxgl.Marker({ element: el })
          .setLngLat(biz.coords)
          .setPopup(new mapboxgl.Popup().setHTML(`
            <img class="popup-logo" src="./logo/${biz.logo}"><br>
            <strong>${biz.name}</strong>
            ${biz.address}
            <a class="popup-link" href="mailto:${biz.email}">${biz.email}</a>
             ${biz.memberUrl ? `<a class="popup-link" href="${biz.memberUrl}" target="_blank">View Member Profile</a>` : ""}
            <a class="popup-link" href="${biz.website}" target="_blank">${biz.website}</a>
            Phone: ${biz.phone}
          `))
          .addTo(map);

        markers.push(marker);
      });
    }

    // Search listener
    searchInput.addEventListener('input', () => {
      searchTerm = searchInput.value;
      renderBusinesses();
    });

    //renderFilterButtons();
    renderBusinesses();

    const allowedDomain = "https://crf-demo2025.bettermode.io";
    if (window.top.location.origin !== allowedDomain) {
      const mapDiv = document.getElementById("map");
      if (mapDiv) {
        mapDiv.remove();
      }
      const sidebarDiv = document.getElementById("sidebar");
      if (sidebarDiv) {
        sidebarDiv.remove();
      }
    }
  </script>

</body>
</html>
